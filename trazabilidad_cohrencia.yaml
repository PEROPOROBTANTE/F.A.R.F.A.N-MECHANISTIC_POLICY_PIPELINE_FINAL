# =============================================================================
# TAREA 4 (VERSIÓN FINAL, EXTENDIDA): OperationalizationAuditor — CDAF
# Auditoría post-inferencia para implementabilidad y coherencia operativa (pToC)
# Ejecutar DESPUÉS de BayesianMechanismInference y CausalExtractor
# Fecha: 2025-11-03 | Versión: 1.5.0
# =============================================================================

auditors:
  OperationalizationAuditor:
    description: "Audita trazabilidad, autoridad operativa, precedencia temporal, proporcionalidad y verificabilidad de la pToC"
    version: "1.5.0"

    depends_on:
      - "BayesianMechanismInference>=1.0.0"
      - "CausalExtractor>=2.2.0"

    # Mantener la secuencia de métodos ya existente en executors.py
    execution_order:
      - method: "audit_evidence_traceability"
      - method: "_audit_systemic_risk"
      - method: "bayesian_counterfactual_audit"
      - method: "_generate_optimal_remediations"

    # -------------------------------------------------------------------------
    # INTEGRACIÓN CON CUESTIONARIO Y CAPAS SEMÁNTICAS (sin cambiar contratos)
    # -------------------------------------------------------------------------
    integration:
      macro_required_for_impacts: true
      meso_required_for_handoffs: true
      scoring_ref:
        micro_levels: ["EXCELENTE","BUENO","ACEPTABLE","INSUFICIENTE"]
        modalities: ["TYPE_A","TYPE_B","TYPE_C","TYPE_D","TYPE_E","TYPE_F"]
      semantic_layers:
        entity_linker: "spaCy_es_core_news_lg"
        embeddings: {model: "multilingual-e5-base", dim: 768, hybrid: {bm25: true, fusion: "RRF"}}
      bridges_to_questionnaire:
        link_rules:
          - when_detected: ["Productos","Causalidad","Resultados"]  # mecanismo explícito P→R
            require_micro: ["D3_Q5"]
          - when_detected: ["Actividades"]
            require_micro: ["D2_Q1","D2_Q2","D2_Q3","D2_Q4","D2_Q5"]
          - when_detected: ["Insumos"]
            require_micro: ["D1_Q1","D1_Q2"]
          - when_detected: ["Impactos"]
            require_macro: ["MACRO_1"]
        scoring_hooks:
          - source: "D3_Q3"  # trazabilidad org-presupuestal
            target: ["Productos","Resultados"]
            bonus: 0.06
          - source: "D3_Q1"  # indicadores de producto incompletos
            target: ["Productos"]
            penalty_if_missing: 0.08

    # -------------------------------------------------------------------------
    # ENTRADAS ESPERADAS (compatibles con tu grafo y metadatos)
    # -------------------------------------------------------------------------
    input_schema:
      plan_meta: {plan_start_year: int, plan_end_year: int, jurisdiction: "es-CO"}
      graph:
        nodes:
          - {id: string, eslabon: enum[Insumos,Actividades,Productos,Resultados,Impactos],
             texto: string, responsable?: string, sector?: string, cluster?: string, policy_area?: string,
             lb?: {year?: int, value?: float, source?: string, unit?: string},
             meta?: {year?: int, value?: float, source?: string, unit?: string},
             unidad?: string, fuente_verificacion?: string,
             presupuesto?: {monto?: float, fuente?: string, bpin?: string, moneda?: "COP"},
             cronograma?: {inicio?: int, fin?: int},
             ubicacion?: {municipio?: string, zona?: enum[urbana,rural], geocelda?: string}}
        edges:
          - {from: string, to: string, conector?: string}
      ontologia_actores:
        actores_validos: [string]
        alias: [{alias: string, canonical: string}]
        relaciones: [{tipo: "coordina_con", a: string, b: string}]

    # -------------------------------------------------------------------------
    # POLÍTICA DE EXCEPCIONES (intervenciones intangibles)
    # -------------------------------------------------------------------------
    exceptions_policy:
      intangible_interventions:
        keywords: ["campaña","sensibilización","comunicación","difusión","educación ciudadana","promoción","prevención blanda"]
        allow_skip_producto: true
        required_justification_patterns:
          - "naturaleza de la intervención"
          - "no se requiere producto físico"
          - "cambio comportamental directo"
        max_skip_ratio: 0.25  # porcentaje máximo de vínculos que pueden saltar Productos
        penalty_if_omitted_justification: 0.10
      emergency_context:
        triggers: ["calamidad pública","emergencia sanitaria","desastre"]
        relax_temporal_checks: true
        notes: "Mantener verificabilidad; justificar cronogramas comprimidos"

    # -------------------------------------------------------------------------
    # PONDERACIONES SECTORIALES (ajustan sensibilidad de reglas de suficiencia)
    # -------------------------------------------------------------------------
    sector_weights:
      salud:        {sufficiency_alpha: 1.10, verification_beta: 1.20}
      educacion:    {sufficiency_alpha: 1.00, verification_beta: 1.10}
      infraestructura: {sufficiency_alpha: 1.25, verification_beta: 1.15}
      seguridad:    {sufficiency_alpha: 1.05, verification_beta: 1.10}
      ambiente:     {sufficiency_alpha: 1.15, verification_beta: 1.15}
      social:       {sufficiency_alpha: 1.05, verification_beta: 1.10}
      default:      {sufficiency_alpha: 1.00, verification_beta: 1.00}

    # -------------------------------------------------------------------------
    # CATEGORÍAS Y REGLAS (AMPLIADAS)
    # -------------------------------------------------------------------------
    categories:

      # 1) TRAZABILIDAD (continuidad productiva)
      - id: "TRAZABILIDAD"
        rules:
          - {rule_id: "OP-AUDIT-001", description: "Producto con Actividad generadora",
             validate: {check: "must_have_parent", parent_type: "Actividades", min_parents: 1},
             failure: {level: "FAIL", code: "OP-FAIL-001", message: "Producto sin Actividad: {producto_id}"},
             rationale: "Sin actividad, el producto es inejecutable."}

          - {rule_id: "OP-AUDIT-002", description: "Resultado con Producto generador",
             validate: {check: "must_have_parent", parent_type: "Productos", min_parents: 1},
             failure: {level: "FAIL", code: "OP-FAIL-002", message: "Resultado sin Producto: {resultado_id}"},
             rationale: "Resultado sin base material es aspiracional."}

          - {rule_id: "OP-AUDIT-003", description: "Actividad con presupuesto (insumo)",
             validate: {check: "must_have_parent", parent_type: "Insumos", subtype: "presupuesto", min_parents: 1},
             failure: {level: "WARN", code: "OP-WARN-003", message: "Actividad sin presupuesto: {actividad_id}"},
             rationale: "Sin recursos, la ejecución es improbable."}

          - {rule_id: "OP-AUDIT-004", description: "Impacto con Resultados vinculados",
             validate: {check: "must_have_parent", parent_type: "Resultados", min_parents: 1},
             failure: {level: "FAIL", code: "OP-FAIL-004", message: "Impacto sin Resultados: {impacto_id}"},
             rationale: "Impactos se construyen desde cambios medibles."}

          - {rule_id: "OP-AUDIT-005", description: "Prohibido Producto huérfano",
             validate: {check: "must_have_parent_and_child", parent_type: "Actividades", child_type: "Resultados"},
             failure: {level: "FAIL", code: "OP-FAIL-005", message: "Producto huérfano: {producto_id}"},
             rationale: "Nodo aislado indica error de diseño."}

          - rule_id: "OP-AUDIT-006"
            description: "Salto Actividad→Resultado requiere justificación explícita"
            validate:
              check: "if_skip_link_then_must_have_justification"
              skip_from: "Actividades"
              skip_to: "Resultados"
              skip_over: "Productos"
              justification_patterns:
                - "naturaleza de la intervención"
                - "campaña|sensibilización"
                - "no se requiere producto físico"
            failure: {level: "WARN", code: "OP-WARN-006", message: "Salto sin justificación: {eslabones_involucrados}"}
            rationale: "Solo válido en intangibles."

          - rule_id: "OP-AUDIT-021"
            description: "Producto→Resultado debe tener arista causal explícita en el grafo"
            validate: {check: "edge_exists", from_type: "Productos", to_type: "Resultados"}
            failure: {level: "WARN", code: "OP-WARN-021", message: "Falta arista P→R para {producto_id}"}
            rationale: "La causalidad no puede quedar implícita."

          - rule_id: "OP-AUDIT-022"
            description: "Actividad→Producto con correspondencia semántica mínima"
            validate:
              check: "semantic_alignment_min"
              min_cosine: 0.45
              fields: [{from: "Actividades.texto", to: "Productos.texto"}]
            failure: {level: "WARN", code: "OP-WARN-022", message: "Baja alineación semántica A↔P: {actividad_id}→{producto_id}"}
            rationale: "Evita emparejamientos arbitrarios."

      # 2) COHERENCIA DE ENTIDADES / ACTORES
      - id: "ACTORES"
        rules:
          - {rule_id: "OP-AUDIT-007", description: "Responsable existe en ontología",
             validate: {check: "actor_exists_in_ontology", actor_field: "responsable", ontology_source: "ontologia_actores_municipales"},
             failure: {level: "WARN", code: "OP-WARN-007", message: "Actor no reconocido: {responsable} ({actividad_id})"},
             rationale: "Evita responsables fantasma."}

          - {rule_id: "OP-AUDIT-008", description: "Actor de Producto coherente con actor de Actividad",
             validate: {check: "actor_coherence_with_parent", parent_type: "Actividades", allowed_cases: ["same_actor","coordinated_actors"]},
             failure: {level: "WARN", code: "OP-WARN-008", message: "Desalineación actor A↔P"},
             rationale: "Handoffs requieren coordinación."}

          - rule_id: "OP-AUDIT-009"
            description: "Cambio de actor exige mecanismo de coordinación"
            validate:
              check: "if_actor_change_then_coordination_mechanism"
              patterns: ["en coordinación con","articulación interinstitucional","comité de coordinación","convenio interadministrativo"]
            failure: {level: "WARN", code: "OP-WARN-009", message: "Cambio de actor sin mecanismo {eslabon_A}→{eslabon_B}"}
            rationale: "Mitiga riesgo en traspasos."

          - rule_id: "OP-AUDIT-023"
            description: "Alias del actor se resuelve al canónico"
            validate: {check: "actor_alias_resolves", actor_field: "responsable"}
            failure: {level: "INFO", code: "OP-INFO-023", message: "Alias no resuelto: {responsable}"}
            rationale: "Homogeneiza trazabilidad."

      # 3) COHERENCIA TEMPORAL
      - id: "TEMPORALIDAD"
        rules:
          - {rule_id: "OP-AUDIT-010", description: "LB ≤ inicio del plan",
             validate: {check: "baseline_year_before_or_equal_plan_start", extract_pattern: "\\b(19|20)\\d{2}\\b", compare_with: "plan_start_year"},
             failure: {level: "FAIL", code: "OP-FAIL-010", message: "LB posterior: {baseline_year} > {plan_start_year}"},
             rationale: "La LB es condición inicial."}

          - {rule_id: "OP-AUDIT-011", description: "Actividad no termina después del Producto",
             validate: {check: "parent_timeline_before_or_simultaneous_child", child_type: "Productos", extract_timeline_pattern: "(20\\d{2})\\s*[-–]?\\s*(20\\d{2})?"},
             failure: {level: "WARN", code: "OP-WARN-011", message: "Producto antes que Actividad"},
             rationale: "Respeta precedencia causal."}

          - {rule_id: "OP-AUDIT-012", description: "Resultados en mediano plazo (años 3–4)",
             validate: {check: "result_target_in_medium_term", expected_year_range: [3,4], extract_pattern: "año\\s+(\\d)|al\\s+final(?:izar)?\\s+(?:el\\s+)?año\\s+(\\d)"},
             failure: {level: "WARN", code: "OP-WARN-012", message: "Resultado a corto plazo"},
             rationale: "Cambios poblacionales toman tiempo."}

          - {rule_id: "OP-AUDIT-013", description: "Impactos en largo plazo (≥ año 4)",
             validate: {check: "impact_target_in_long_term", min_expected_year: 4, extract_pattern: "año\\s+(\\d+)|al finalizar el plan|largo plazo"},
             failure: {level: "WARN", code: "OP-WARN-013", message: "Impacto en corto plazo"},
             rationale: "Transformaciones estructurales requieren maduración."}

          - rule_id: "OP-AUDIT-024"
            description: "Cronogramas no deben retroceder en el tiempo en el grafo"
            validate: {check: "dag_temporal_consistency"}
            failure: {level: "FAIL", code: "OP-FAIL-024", message: "Inconsistencia DAG temporal"}
            rationale: "Evita ciclos y regresiones temporales."

      # 4) SUFICIENCIA Y PROPORCIONALIDAD
      - id: "SUFICIENCIA"
        rules:
          - {rule_id: "OP-AUDIT-014", description: "Población objetivo coherente con diagnóstico (±20%)",
             validate: {check: "target_population_coherent_with_baseline", tolerance: 0.20, extract_population_pattern: "(\\d+(?:[.,]\\d{3})*)\\s+(personas|familias|hogares|habitantes)"},
             failure: {level: "WARN", code: "OP-WARN-014", message: "Focalización incoherente: {actividad_pop} vs {diagnostico_pop}"},
             rationale: "Evita sobredimensionamientos."}

          - rule_id: "OP-AUDIT-015"
            description: "Suma de Productos proporcional a meta de Resultado"
            validate:
              check: "sum_of_products_proportional_to_result"
              sector_adjust: true
              flags:
                - {type: "underproduction", condition: "sum_productos < 0.5 * meta_resultado"}
                - {type: "overproduction",  condition: "sum_productos > 3.0 * meta_resultado"}
            failure: {level: "WARN", code: "OP-WARN-015", message: "Proporcionalidad cuestionable ({flag_type})"}
            rationale: "Anti-milagro lógico."

          - {rule_id: "OP-AUDIT-016", description: "Producto cuantificado exige Resultado cuantificado",
             validate: {check: "if_product_quantified_then_result_quantified", quantified_pattern: "\\d+(?:[.,]\\d+)?\\s*%?\\s+(de|en)"},
             failure: {level: "WARN", code: "OP-WARN-016", message: "Producto cuantificado → Resultado cualitativo"},
             rationale: "El cambio debe ser medible."}

          - {rule_id: "OP-AUDIT-017", description: "Fortalecimiento institucional con productos verificables",
             validate: {check: "fortification_activity_has_tangible_product", activity_keywords: ["fortalecer","consolidar","institucionalizar"], invalid_products: ["proceso fortalecido","capacidad instalada","gestión mejorada"]},
             failure: {level: "WARN", code: "OP-WARN-017", message: "Fortalecimiento sin productos verificables: {actividad_id}"},
             rationale: "Pide sistemas, protocolos, personas capacitadas."}

          - rule_id: "OP-AUDIT-025"
            description: "Presupuesto agregado coherente con magnitud de metas"
            validate:
              check: "budget_to_output_ratio"
              heuristics:
                infraestructura: {min_cop_per_unit_km: 100000000, min_cop_per_unit_sede: 2000000000}
                educacion:       {min_cop_per_capacitado: 200000}
                salud:           {min_cop_por_evento_clave: 500000}
            failure: {level: "WARN", code: "OP-WARN-025", message: "Presupuesto irreal vs metas (ratio anómalo)"}
            rationale: "Evita metas desalineadas con recursos."

      # 5) VERIFICABILIDAD
      - id: "VERIFICABILIDAD"
        rules:
          - {rule_id: "OP-AUDIT-018", description: "Producto con medio/fuente de verificación",
             validate: {check: "has_verification_source", patterns: ["fuente de verificación","medio de verificación","se verificará mediante","registro (fotográfico|administrativo|documental)"]},
             failure: {level: "WARN", code: "OP-WARN-018", message: "Producto sin medio de verificación: {producto_id}"},
             rationale: "Sin evidencia no hay auditoría."}

          - {rule_id: "OP-AUDIT-019", description: "Resultado con indicador + fórmula o fuente",
             validate: {check: "has_indicator_with_formula_or_source", patterns: ["indicador:","fórmula:","se calculará como","fuente:"]},
             failure: {level: "FAIL", code: "OP-FAIL-019", message: "Resultado sin indicador/fórmula/fuente: {resultado_id}"},
             rationale: "Resultados sin medición son aspiraciones."}

          - {rule_id: "OP-AUDIT-020", description: "Meta numérica exige línea base del mismo indicador",
             validate: {check: "if_target_exists_then_baseline_exists", target_pattern: "meta:\\s*(\\d+(?:[.,]\\d+)?\\s*%?)", same_indicator_check: true},
             failure: {level: "WARN", code: "OP-WARN-020", message: "Meta sin LB correspondiente: {indicador_name}"},
             rationale: "Medir cambio implica conocer el punto de partida."}

          - rule_id: "OP-AUDIT-026"
            description: "Unidades consistentes entre LB, meta y producto"
            validate: {check: "unit_consistency", fields: ["lb.unit","meta.unit","unidad"]}
            failure: {level: "FAIL", code: "OP-FAIL-026", message: "Inconsistencia de unidades (LB/Meta/Producto)"}
            rationale: "Evita % vs números absolutos mal combinados."

          - rule_id: "OP-AUDIT-027"
            description: "Fuente oficial o trazable para LB/Meta"
            validate: {check: "source_trustworthiness_min", allow: ["DANE","SISPRO","SIMAT","SUI","Policía Nacional","Medicina Legal","UARIV","ICBF","Registro administrativo","Encuesta local documentada"]}
            failure: {level: "WARN", code: "OP-WARN-027", message: "Fuente débil/no oficial para LB/Meta"}
            rationale: "Refuerza M&E con datos confiables."

      # 6) INTEGRIDAD DE DATOS (calidad, duplicados, vacíos)
      - id: "INTEGRIDAD_DATOS"
        rules:
          - rule_id: "OP-AUDIT-028"
            description: "IDs únicos en nodos y aristas"
            validate: {check: "unique_ids"}
            failure: {level: "FAIL", code: "OP-FAIL-028", message: "IDs duplicados"}
            rationale: "Base para trazabilidad."

          - rule_id: "OP-AUDIT-029"
            description: "Campos clave no vacíos (texto, eslabon, responsable en A/P, cronograma en A/P)"
            validate: {check: "required_fields_nonempty"}
            failure: {level: "WARN", code: "OP-WARN-029", message: "Campos críticos vacíos"}
            rationale: "Evita huecos operativos."

          - rule_id: "OP-AUDIT-030"
            description: "Moneda y formato de presupuesto válidos"
            validate: {check: "currency_format_valid", allowed: ["COP"], patterns: ["\\$\\s*[\\d\\.,]+","COP\\s*[\\d\\.,]+","millones de pesos"]}
            failure: {level: "WARN", code: "OP-WARN-030", message: "Formato de presupuesto inválido"}
            rationale: "Estandariza comparabilidad."

      # 7) CONSISTENCIA GEOGRÁFICA
      - id: "GEOGRAFIA"
        rules:
          - rule_id: "OP-AUDIT-031"
            description: "Ubicación declarada coherente con cobertura del resultado"
            validate: {check: "geo_scope_consistency", fields: ["ubicacion","cluster","policy_area"]}
            failure: {level: "WARN", code: "OP-WARN-031", message: "Incoherencia geográfica"}
            rationale: "Evita prometer coberturas fuera del ámbito."

          - rule_id: "OP-AUDIT-032"
            description: "Focalización (urbana/rural) consistente con diagnóstico"
            validate: {check: "urban_rural_alignment"}
            failure: {level: "WARN", code: "OP-WARN-032", message: "Desalineación urbano-rural"}
            rationale: "Ajusta al contexto territorial."

      # 8) PRESUPUESTO Y CONTRATACIÓN (legal/operativo)
      - id: "PRESUPUESTO_Y_LEGAL"
        rules:
          - rule_id: "OP-AUDIT-033"
            description: "BPIN presente cuando aplique a proyecto de inversión"
            validate: {check: "bpin_presence_when_required"}
            failure: {level: "WARN", code: "OP-WARN-033", message: "Falta código BPIN requerido"}
            rationale: "Trazabilidad presupuestal."

          - rule_id: "OP-AUDIT-034"
            description: "Fuentes de financiación suman al total declarado"
            validate: {check: "funding_sum_matches_total"}
            failure: {level: "FAIL", code: "OP-FAIL-034", message: "Descuadre de financiación"}
            rationale: "Coherencia financiera básica."

          - rule_id: "OP-AUDIT-035"
            description: "Cronograma compatible con modalidades de contratación"
            validate: {check: "procurement_timeline_plausibility"}
            failure: {level: "WARN", code: "OP-WARN-035", message: "Plazos incompatibles con contratación"}
            rationale: "Evita supuestos irrealistas."

      # 9) RIESGOS Y CONTINGENCIAS (operativos)
      - id: "RIESGOS_Y_CONTINGENCIAS"
        rules:
          - rule_id: "OP-AUDIT-036"
            description: "Riesgos críticos identificados con medidas de mitigación"
            validate: {check: "risks_with_mitigation", min_risks: 2}
            failure: {level: "WARN", code: "OP-WARN-036", message: "Riesgos sin mitigación"}
            rationale: "Asegura continuidad operativa."

          - rule_id: "OP-AUDIT-037"
            description: "Indicadores sensibles a riesgos tienen plan de continuidad"
            validate: {check: "continuity_plan_for_critical_indicators"}
            failure: {level: "WARN", code: "OP-WARN-037", message: "Sin plan de continuidad para indicadores críticos"}
            rationale: "Resiliencia en M&E."

      # 10) COHERENCIA CON PERSPECTIVA DE GÉNERO Y DIFERENCIAL
      - id: "ENFOQUE_DIFERENCIAL"
        rules:
          - rule_id: "OP-AUDIT-038"
            description: "Productos/Resultados declaran población objetivo diferenciada si aplicable"
            validate: {check: "differential_target_presence", triggers: ["mujeres","niñas","jóvenes","población víctima","étnico","discapacidad","rural disperso"]}
            failure: {level: "WARN", code: "OP-WARN-038", message: "Falta enfoque diferencial donde aplica"}
            rationale: "Coherencia con diagnóstico y política pública."

          - rule_id: "OP-AUDIT-039"
            description: "Metas desagregadas por sexo/edad cuando el diagnóstico lo exige"
            validate: {check: "disaggregation_required_then_present"}
            failure: {level: "WARN", code: "OP-WARN-039", message: "Falta desagregación exigida"}
            rationale: "Medición sensible a desigualdades."

    # -------------------------------------------------------------------------
    # SEVERIDAD, AGREGACIÓN Y UMBRALES (manteniendo tu fórmula base)
    # -------------------------------------------------------------------------
    execution_config:
      fail_fast: false
      severity_levels:
        FAIL: {weight: 1.0, color: "red",   action: "Corrección obligatoria"}
        WARN: {weight: 0.5, color: "yellow",action: "Plan de mejora"}
        INFO: {weight: 0.0, color: "blue",  action: "Mejora continua"}
      aggregation_method: "weighted_sum"
      audit_score_formula: "1.0 - (Σ(severity_weight) / rules_evaluated)"
      thresholds:
        APROBADO:   {min_score: 0.85, description: "Operacionalización robusta"}
        ACEPTABLE:  {min_score: 0.70, description: "Problemas menores, corregibles"}
        DEFICIENTE: {min_score: 0.50, description: "Requiere revisión sustantiva"}
        RECHAZADO:  {min_score: 0.00, max_score: 0.49, description: "Fallas críticas"}

    # -------------------------------------------------------------------------
    # PROPAGACIÓN DE CONFIANZA BAYESIANA (ajusta sanciones según evidencia)
    # -------------------------------------------------------------------------
    bayesian_coupling:
      posterior_thresholds:
        high_conf:   {min: 0.80, rule_weight_multiplier: 1.10}
        medium_conf: {min: 0.60, rule_weight_multiplier: 1.00}
        low_conf:    {min: 0.40, rule_weight_multiplier: 0.90}
        very_low:    {min: 0.00, rule_weight_multiplier: 0.75}
      note: "Si la evidencia causal es altísima, pequeñas faltas operativas pesan más; si es baja, se prioriza remediación gradual."

    # -------------------------------------------------------------------------
    # SALIDAS, TELEMETRÍA Y RASTREABILIDAD (ampliadas)
    # -------------------------------------------------------------------------
    outputs:
      schema:
        - {name: "rule_id", type: "string"}
        - {name: "node_id", type: "string"}
        - {name: "level",   type: "enum[FAIL,WARN,INFO]"}
        - {name: "code",    type: "string"}
        - {name: "message", type: "string"}
        - {name: "evidence",type: "array[string]"}
        - {name: "remediation_suggestion", type: "string"}
        - {name: "span",    type: "tuple[int,int]"}
        - {name: "trace_id",type: "string"}
      telemetry:
        spans: ["VALIDATE_LINKS","VALIDATE_TIME","VALIDATE_SUFFICIENCY","VALIDATE_VERIFIABILITY","DATA_INTEGRITY","GEO_SCOPE","BUDGET_COHERENCE"]
        logs: {format: "jsonl", fields: ["timestamp","rule_id","node_id","level","severity_weight","trace_id","latency_ms","ruleset_hash"]}
        metrics:
          - {name: "validation_failure_rate", aggregation: "p95"}
          - {name: "rule_latency_ms",         aggregation: "p95"}
          - {name: "violations_by_category",  aggregation: "sum"}
      integrity:
        ruleset_hash: "a4e9f3b2c0b1494db61c5c8e4e9e08a9b2dd7d3a9e56a3db2a77a4b6f9d20f31"
        compatible_with_monolith_hash: "de52721917492cac3e6c548dc7457d9de68b66183bebdaf825e090e3bbdba6d0"

    # -------------------------------------------------------------------------
    # PLANTILLAS DE REMEDIACIÓN (generadas por _generate_optimal_remediations)
    # -------------------------------------------------------------------------
    remediation_playbook:
      OP-FAIL-001: "Declare y vincule la Actividad generadora; añada responsable, cronograma y fuente presupuestal."
      OP-FAIL-002: "Materialice Productos intermedios con unidad y meta; vincúlelos al Resultado con indicador."
      OP-WARN-003: "Enlace a POAI/PPI o detalle fuente SGP/regalías/recursos propios con monto y vigencia."
      OP-FAIL-004: "Desagregue Impacto en Resultados medibles; origine aristas desde resultados con metas."
      OP-FAIL-005: "Conecte el Producto a su Actividad y al Resultado objetivo; si no aplica, reubique como Actividad."
      OP-WARN-006: "Justifique el salto A→R por naturaleza intangible; documente mecanismo de cambio."
      OP-WARN-008: "Unifique responsable o registre convenio/acta de coordinación interinstitucional."
      OP-FAIL-010: "Corrija la línea base al año ≤ inicio del plan; cite fuente oficial."
      OP-WARN-011: "Alinee cronogramas: actividad debe culminar ≤ hito de entrega del producto."
      OP-WARN-012: "Reubique metas de resultado a años 3–4; detalle productos previos."
      OP-WARN-013: "Defina horizonte de impacto al final del plan o posterior; refuerce con indicadores de desarrollo."
      OP-WARN-014: "Ajuste población objetivo al diagnóstico (±20%) o motive técnicamente el desvío."
      OP-WARN-015: "Recalibre la dosificación de productos o la meta del resultado; agregue supuestos."
      OP-WARN-016: "Cuantifique el resultado con fórmula/fuente consistente con el producto."
      OP-WARN-017: "Sustituya retórica por tangibles: # funcionarios capacitados, # sistemas/protocolos implementados."
      OP-WARN-018: "Añada medio de verificación: acta, registro fotográfico, base de datos o informe."
      OP-FAIL-019: "Defina indicador con fórmula y fuente; sin esto, el resultado no es auditable."
      OP-WARN-020: "Incluya línea base del mismo indicador (año y valor) o ajuste la meta."
      OP-FAIL-026: "Homologue unidades entre LB/Meta/Producto; evite % vs conteos cruzados."
      OP-FAIL-034: "Cuadre fuentes de financiación con el total; documente supuestos y cofinanciación."
      default: "Documente vínculo, evidencia y cronograma; asegure trazabilidad y verificabilidad."

    # -------------------------------------------------------------------------
    # PRUEBAS UNITARIAS (ampliadas)
    # -------------------------------------------------------------------------
    tests:
      - name: "trazabilidad_basica_ok"
        graph_snippet:
          A: {type: "Actividades", texto: "Construir 5 aulas", responsable: "Sec. Infraestructura", presupuesto: {monto: 2500000000, fuente: "Regalías"}}
          P: {type: "Productos", texto: "5 aulas construidas", fuente_verificacion: "Acta de entrega", unidad: "aulas"}
          R: {type: "Resultados", texto: "Aumentar cobertura en 200 estudiantes", meta: {value: 200, year: 2026, unit: "estudiantes"}, lb: {value: 0, year: 2024, unit: "estudiantes"}}
        edges: [{from: "A", to:"P"},{from:"P", to:"R"}]
        expect: {min_score: 0.85, no_fail: true}

      - name: "resultado_sin_producto_fail"
        graph_snippet:
          R: {type:"Resultados", texto:"Reducir deserción al 6% en 2025", meta:{value:6, year:2025, unit:"%"}}
        edges: []
        expect_fail_codes: ["OP-FAIL-002"]

      - name: "lb_en_el_futuro_fail"
        graph_snippet:
          I: {type:"Insumos", texto:"LB de pobreza 2026: 34%"}
          R: {type:"Resultados", texto:"Reducir pobreza a 30% en 2027", meta:{value:30, year:2027, unit:"%"}}
        plan_meta: {plan_start_year: 2024, plan_end_year: 2027}
        expect_fail_codes: ["OP-FAIL-010"]

      - name: "intangibles_salto_permitido_con_justificacion"
        graph_snippet:
          A: {type:"Actividades", texto:"Campaña de sensibilización sobre VBG; por la naturaleza de la intervención, no se requiere producto físico."}
          R: {type:"Resultados", texto:"Disminuye la tolerancia social a la VBG (meta 20% mejora percepción 2027)", meta:{value:20, year:2027, unit:"%"}}
        edges: [{from:"A", to:"R"}]
        expect_warn_codes: ["OP-WARN-006"]

      - name: "unidades_inconsistentes_fail"
        graph_snippet:
          I: {type:"Insumos", lb:{value: 12.5, year: 2023, unit:"%"}}
          R: {type:"Resultados", meta:{value: 1000, year: 2027, unit:"personas"}}
          P: {type:"Productos", unidad:"kits"}
        edges: [{from:"P","to":"R"}]
        expect_fail_codes: ["OP-FAIL-026"]
