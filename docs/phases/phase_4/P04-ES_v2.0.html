<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F.A.R.F.A.N. | Fase 4: Agregación a Nivel de Dimensión</title>
    <style>
        :root {
            --atroz-red-500: #C41E3A; --atroz-blue-electric: #00D4FF; --atroz-green-toxic: #39FF14;
            --atroz-copper-500: #B2642E; --atroz-copper-oxide: #17A589; --atroz-ink: #E5E7EB; --atroz-bg: #0A0A0A;
            --font-main: 'JetBrains Mono', monospace;
        }
        @font-face {
            font-family: 'JetBrains Mono';
            src: url('https://cdn.jsdelivr.net/gh/JetBrains/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2') format('woff2');
            font-weight: 400; font-style: normal;
        }
        body { background-color: var(--atroz-bg); color: var(--atroz-ink); font-family: var(--font-main); margin: 0; padding: 0; font-size: 14px; line-height: 1.8; }
        .container { max-width: 960px; margin: 0 auto; padding: 40px; }
        h1, h2, h3 { font-weight: 400; letter-spacing: 2px; text-transform: uppercase; }
        h1 { font-size: 28px; color: var(--atroz-green-toxic); border-bottom: 1px solid var(--atroz-copper-500); padding-bottom: 15px; margin-bottom: 30px; }
        h2 { font-size: 18px; color: var(--atroz-copper-oxide); margin-top: 50px; border-left: 3px solid var(--atroz-copper-oxide); padding-left: 10px; }
        h3 { font-size: 16px; color: var(--atroz-copper-500); margin-top: 30px; }
        p, li { text-align: justify; text-shadow: 0 0 2px rgba(229, 231, 235, 0.1); }
        ul, ol { padding-left: 20px; }
        li { margin-bottom: 10px; }
        code { background-color: #1a1a1a; padding: 3px 6px; border-radius: 4px; font-size: 12px; color: var(--atroz-blue-electric); }
        .diagram-container { margin: 50px 0; padding: 30px; background: radial-gradient(circle, rgba(57, 255, 20, 0.1) 0%, transparent 70%); border: 1px solid var(--atroz-green-toxic); border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fase 4: Síntesis a Nivel Meso mediante Agregación de Dimensiones</h1>

        <h2>1. Propósito</h2>
        <p>
            La Fase 4 inicia la síntesis jerárquica de los datos granulares producidos en las fases precedentes. Su objetivo principal es agregar los aproximadamente 300 resultados individuales de <code>ScoredMicroQuestion</code> en 60 unidades analíticas distintas de nivel meso. Cada una de estas unidades, representada por un objeto <code>DimensionScore</code>, corresponde a una intersección única de Área de Política-Dimensión. Esta fase marca un cambio crítico del análisis de puntos de datos individuales a la evaluación de tendencias y rendimientos temáticos. La lógica de agregación no es un simple promedio; es un cálculo ponderado gobernado por reglas y parámetros especificados en el objeto <code>AggregationSettings</code>, que fue derivado del monolito en la Fase 0.
        </p>

        <h2>2. Definiciones Clave</h2>
        <ul>
            <li><strong>Agregación de Dimensión:</strong> El proceso de agrupar y calcular una única puntuación representativa para todas las micro-preguntas que pertenecen a la misma Área de Política y Dimensión.</li>
            <li><strong>DimensionAggregator:</strong> Una clase especializada de <code>aggregation.py</code> que contiene la lógica de negocio para agrupar los resultados puntuados y aplicar los algoritmos de ponderación y agregación correctos.</li>
            <li><strong>AggregationSettings:</strong> Un objeto de configuración, cargado durante la Fase 0, que proporciona todos los parámetros necesarios para la agregación, incluyendo pesos para diferentes tipos de preguntas y umbrales para las bandas de calidad.</li>
            <li><strong>DimensionScore:</strong> El artefacto de salida de esta fase para cada uno de los 60 grupos. Encapsula la puntuación agregada, una lista de los resultados de las micro-preguntas contribuyentes e información de diagnóstico sobre el proceso de agregación.</li>
        </ul>

        <h2>3. Flujo Operacional Detallado</h2>
        <p>
            El proceso es gestionado por el método <code>Orchestrator._aggregate_dimensions_async()</code> y se ejecuta de forma concurrente para los diferentes grupos.
        </p>
        <ol>
            <li><strong>Validación de Datos:</strong> La lista de entrada de ~300 objetos <code>ScoredMicroQuestion</code> pasa primero por una función de validación, <code>validate_scored_results</code>, para asegurar la integridad estructural y la presencia de los metadatos necesarios (ej., puntuaciones válidas, <code>policy_area</code>, <code>dimension</code>).</li>
            <li><strong>Agrupación (Grouping):</strong> La lista validada de resultados puntuados se agrupa en un diccionario o mapa hash. La clave para cada grupo es una tupla compuesta por los identificadores de <code>policy_area</code> y <code>dimension</code>. Esto resulta en 60 grupos distintos de resultados de micro-preguntas.</li>
            <li><strong>Agregación Concurrente:</strong> El sistema procesa los 60 grupos en paralelo. Para cada grupo, se inicia una tarea asíncrona.</li>
            <li><strong>Invocación del Agregador:</strong> Dentro de cada tarea, se invoca el <code>DimensionAggregator</code>. Se llama a su método <code>aggregate_dimension</code>, recibiendo la lista de resultados puntuados para ese grupo específico.</li>
            <li><strong>Cálculo Ponderado:</strong> El agregador aplica la lógica definida en el <code>AggregationSettings</code>. Esto típicamente implica aplicar diferentes pesos a las puntuaciones normalizadas de las micro-preguntas según su tipo o importancia, y luego calcular una media ponderada o una medida estadística más compleja.</li>
            <li><strong>Instanciación de DimensionScore:</strong> El resultado del cálculo se encapsula dentro de un objeto <code>DimensionScore</code>. Este objeto no solo contiene la puntuación final, sino que también mantiene un vínculo con los datos de las micro-preguntas subyacentes, asegurando una trazabilidad completa de la evidencia.</li>
            <li><strong>Recolección de Resultados:</strong> El orquestador recolecta los 60 objetos <code>DimensionScore</code> de las tareas asíncronas completadas. Esta colección forma la salida completa de la Fase 4 y sirve como entrada directa para la Fase 5.</li>
        </ol>

        <h2>4. Diagrama de Sistema: Agregación por Agrupación y Reducción</h2>
        <div class="diagram-container">
            <svg width="100%" viewBox="0 0 900 600" xmlns="http://www.w3.org/2000/svg" font-family="JetBrains Mono, monospace" font-size="12px">
                <defs>
                    <linearGradient id="grad-blue" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#00D4FF"/><stop offset="100%" stop-color="#04101A"/></linearGradient>
                    <linearGradient id="grad-green" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#39FF14"/><stop offset="100%" stop-color="#0B231B"/></linearGradient>
                    <marker id="arrow-copper" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#B2642E"/></marker>
                </defs>
                <style>
                    .box { stroke-width: 1.5; rx: 4px; }
                    .box-blue { fill: url(#grad-blue); stroke: #00D4FF; }
                    .box-green { fill: url(#grad-green); stroke: #39FF14; }
                    .label { fill: #E5E7EB; text-anchor: middle; }
                    .sub-label { fill: #E5E7EB; opacity: 0.7; font-size: 9px; text-anchor: middle; }
                    .flow-line { stroke: #B2642E; stroke-width: 1.5; marker-end: url(#arrow-copper); }
                </style>

                <rect x="300" y="20" width="300" height="50" class="box box-green"/>
                <text x="450" y="50" class="label">Entrada: Lista de ~300 ScoredMicroQuestions</text>

                <path class="flow-line" d="M450 70 V 110"/>

                <rect x="350" y="110" width="200" height="60" class="box box-blue"/>
                <text x="450" y="140" class="label">Fase de Agrupación</text>
                <text x="450" y="155" class="sub-label">Clave: (policy_area, dimension)</text>

                <path class="flow-line" d="M450 170 V 210"/>

                <!-- Groups -->
                <g id="groups">
                    <rect x="50" y="210" width="150" height="60" fill="rgba(0,212,255,0.1)" stroke="#00D4FF" stroke-dasharray="2,2"/>
                    <text x="125" y="240" class="label" font-size="10px">Grupo: PA01-DIM01</text>
                    <text x="125" y="255" class="sub-label">~5 items</text>

                    <rect x="250" y="210" width="150" height="60" fill="rgba(0,212,255,0.1)" stroke="#00D4FF" stroke-dasharray="2,2"/>
                    <text x="325" y="240" class="label" font-size="10px">Grupo: PA01-DIM02</text>
                    <text x="325" y="255" class="sub-label">~5 items</text>

                    <text x="475" y="245" class="label" font-size="20px">...</text>

                    <rect x="700" y="210" width="150" height="60" fill="rgba(0,212,255,0.1)" stroke="#00D4FF" stroke-dasharray="2,2"/>
                    <text x="775" y="240" class="label" font-size="10px">Grupo: PA10-DIM06</text>
                    <text x="775" y="255" class="sub-label">~5 items</text>
                </g>

                <path class="flow-line" d="M125 270 V 310"/>
                <path class="flow-line" d="M325 270 V 310"/>
                <path class="flow-line" d="M775 270 V 310"/>

                <!-- Aggregation Logic -->
                <g id="aggregation">
                    <rect x="50" y="310" width="150" height="50" class="box box-blue"/>
                    <text x="125" y="340" class="label">DimensionAggregator</text>
                    <rect x="250" y="310" width="150" height="50" class="box box-blue"/>
                    <text x="325" y="340" class="label">DimensionAggregator</text>
                    <text x="475" y="340" class="label" font-size="20px">...</text>
                    <rect x="700" y="310" width="150" height="50" class="box box-blue"/>
                    <text x="775" y="340" class="label">DimensionAggregator</text>
                </g>

                <path class="flow-line" d="M125 360 V 400"/>
                <path class="flow-line" d="M325 360 V 400"/>
                <path class="flow-line" d="M775 360 V 400"/>

                <!-- Aggregated Results -->
                <g id="results">
                    <rect x="50" y="400" width="150" height="50" class="box box-green"/>
                    <text x="125" y="430" class="label">DimensionScore</text>
                    <rect x="250" y="400" width="150" height="50" class="box box-green"/>
                    <text x="325" y="430" class="label">DimensionScore</text>
                    <text x="475" y="430" class="label" font-size="20px">...</text>
                    <rect x="700" y="400" width="150" height="50" class="box box-green"/>
                    <text x="775" y="430" class="label">DimensionScore</text>
                </g>

                <path class="flow-line" d="M125 450 v 40 H 450"/>
                <path class="flow-line" d="M325 450 v 40 H 450"/>
                <path class="flow-line" d="M775 450 v 40 H 450"/>

                <path class="flow-line" d="M450 490 V 520"/>

                <rect x="325" y="520" width="250" height="50" class="box box-green"/>
                <text x="450" y="550" class="label">Salida: Lista de 60 DimensionScores</text>
            </svg>
        </div>

        <h2>5. Pseudocódigo Ilustrativo</h2>
        <pre><code>
FUNCIÓN ASÍNCRONA _aggregate_dimensions_async(resultados_puntuados, config):
    // Paso 1: Validar la integridad de los datos de entrada
    resultados_validados = validate_scored_results(resultados_puntuados)

    // Paso 2: Agrupar resultados por la clave compuesta (policy_area, dimension)
    resultados_agrupados = AGRUPAR_POR(resultados_validados, clave="policy_area, dimension")

    // Paso 3: Procesar concurrentemente cada uno de los 60 grupos
    tareas = []
    PARA clave_grupo, items EN resultados_agrupados.items():
        tarea = CREAR_TAREA(agregar_dimension_individual(items, config.aggregation_settings))
        tareas.APILAR(tarea)

    puntuaciones_dimension = ESPERAR asyncio.gather(*tareas)
    RETORNAR puntuaciones_dimension

FUNCIÓN agregar_dimension_individual(items, settings):
    // Paso 4: Instanciar el motor de agregación
    agregador = nuevo DimensionAggregator(settings)

    // Paso 5: Realizar el cálculo ponderado
    // Esto implica aplicar pesos específicos de 'settings' a la puntuación de cada item
    puntuacion_agregada = agregador.aggregate_dimension(items)

    // Paso 6: Encapsular en la estructura de salida canónica
    RETORNAR nuevo DimensionScore(
        score = puntuacion_agregada,
        contributing_items = items,
        ...
    )
        </code></pre>

        <h2>6. Lista de Verificación Operacional para Auditoría</h2>
        <ul>
            <li><strong>Verificar Recuento de Entrada:</strong> Asegurar que el número de objetos <code>ScoredMicroQuestion</code> que entran a la fase es correcto (~300).</li>
            <li><strong>Verificar Recuento de Salida:</strong> Afirmar que la salida final es una lista que contiene exactamente 60 objetos <code>DimensionScore</code>.</li>
            <li><strong>Auditar una Agregación Individual:</strong> Seleccionar un grupo PA-DIM. Inspeccionar manualmente las puntuaciones de sus micro-preguntas contribuyentes y compararlas con el <code>DimensionScore</code> agregado final para verificar la plausibilidad del cálculo.</li>
            <li><strong>Comprobar Pérdida de Datos:</strong> Confirmar que la suma del número de ítems contribuyentes en todos los 60 objetos <code>DimensionScore</code> es igual al número total de ítems válidos (sin errores) de la lista de entrada.</li>
            <li><strong>Inspeccionar Ajustes de Agregación:</strong> Verificar que el <code>DimensionAggregator</code> está cargando y utilizando correctamente el <code>AggregationSettings</code> del objeto de configuración certificado.</li>
        </ul>
    </div>
</body>
</html>
