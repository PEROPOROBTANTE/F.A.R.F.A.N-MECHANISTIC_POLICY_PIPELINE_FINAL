<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F.A.R.F.A.N. | Phase 0: Configuration Integrity and Contract Validation</title>
    <style>
        :root {
            --atroz-red-500: #C41E3A; --atroz-blue-electric: #00D4FF; --atroz-green-toxic: #39FF14;
            --atroz-copper-500: #B2642E; --atroz-copper-oxide: #17A589; --atroz-ink: #E5E7EB; --atroz-bg: #0A0A0A;
            --font-main: 'JetBrains Mono', monospace;
        }
        @font-face {
            font-family: 'JetBrains Mono';
            src: url('https://cdn.jsdelivr.net/gh/JetBrains/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2') format('woff2');
            font-weight: 400; font-style: normal;
        }
        body { background-color: var(--atroz-bg); color: var(--atroz-ink); font-family: var(--font-main); margin: 0; padding: 0; font-size: 14px; line-height: 1.8; }
        .container { max-width: 960px; margin: 0 auto; padding: 40px; }
        h1, h2, h3 { font-weight: 400; letter-spacing: 2px; text-transform: uppercase; }
        h1 { font-size: 28px; color: var(--atroz-red-500); border-bottom: 1px solid var(--atroz-copper-500); padding-bottom: 15px; margin-bottom: 30px; }
        h2 { font-size: 18px; color: var(--atroz-copper-oxide); margin-top: 50px; border-left: 3px solid var(--atroz-copper-oxide); padding-left: 10px; }
        h3 { font-size: 16px; color: var(--atroz-copper-500); margin-top: 30px; }
        p { margin-bottom: 20px; text-align: justify; text-shadow: 0 0 2px rgba(229, 231, 235, 0.1); }
        ul, ol { padding-left: 20px; }
        li { margin-bottom: 10px; text-align: justify; }
        code { background-color: #1a1a1a; padding: 3px 6px; border-radius: 4px; font-size: 12px; color: var(--atroz-blue-electric); }
        .diagram-container { margin: 50px 0; padding: 30px; background: radial-gradient(circle, rgba(196, 30, 58, 0.1) 0%, transparent 70%); border: 1px solid var(--atroz-red-500); border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Phase 0: Configuration Integrity and Contract Validation</h1>

        <h2>1. Purpose</h2>
        <p>
            Phase 0 constitutes the foundational validation gate of the entire F.A.R.F.A.N. pipeline. Its primary objective is to ensure the structural, semantic, and cryptographic integrity of the central configuration object, colloquially termed the "monolith." This phase operates under a zero-tolerance policy; any deviation from the established contracts results in an immediate and fatal termination of the orchestration process. The successful completion of this phase yields a certified configuration object, which serves as the immutable source of truth for all subsequent analytical and processing stages, thereby guaranteeing systemic coherence and reproducibility.
        </p>

        <h2>2. Key Definitions</h2>
        <ul>
            <li><strong>Monolith:</strong> A comprehensive JSON object that codifies the entire analytical framework, including all micro, meso, and macro questions, scoring modalities, hierarchical relationships between policy areas and clusters, and aggregation rules.</li>
            <li><strong>SHA-256 Hash:</strong> A cryptographic signature of the monolith's content, ensuring that the configuration is unaltered and providing a verifiable identifier for provenance tracking.</li>
            <li><strong>Structural Contract:</strong> A set of implicit and explicit rules governing the internal consistency of the monolith, such as the exact count of expected questions, the presence of all required scoring modalities, and the logical mapping between policy areas and clusters.</li>
            <li><strong>Certified Configuration Object:</strong> The validated output of Phase 0, bundling the original monolith, its SHA-256 hash, and reports from the validation checks.</li>
        </ul>

        <h2>3. Step-by-Step Operational Flow</h2>
        <p>
            The operational sequence of Phase 0 is executed by the <code>Orchestrator._load_configuration()</code> method. The process is strictly linear and every step must pass for the next to initiate.
        </p>
        <ol>
            <li><strong>Monolith Normalization:</strong> The input monolith data, which may exist as a <code>MappingProxyType</code>, is recursively converted into a standard dictionary. This ensures consistent serialization for the subsequent hashing step.</li>
            <li><strong>Cryptographic Hashing:</strong> The normalized monolith is serialized into a compact, sorted JSON string. This string is then encoded to UTF-8 and processed through the SHA-256 algorithm to produce a unique, content-addressable hash.</li>
            <li><strong>Component Census Validation:</strong> The system performs a quantitative audit, comparing the number of micro, meso, and macro questions found within the monolith against hard-coded contractual constants (<code>EXPECTED_QUESTION_COUNT</code>). A similar check is performed for the number of available methods. A mismatch at this stage indicates a severe desynchronization between the code and its configuration.</li>
            <li><strong>Structural Contract Validation:</strong> The <code>_validate_contract_structure()</code> method is invoked. This function performs a deep analysis of the monolith's architecture, verifying:
                <ul>
                    <li>The presence of exactly 30 unique "base slots."</li>
                    <li>The definition of all six required scoring modalities (TYPE_A to TYPE_F).</li>
                    <li>The consistent and unambiguous mapping of policy areas to their parent clusters.</li>
                </ul>
            </li>
            <li><strong>Aggregation Settings Generation:</strong> Upon successful validation, the <code>AggregationSettings.from_monolith()</code> constructor is called. This function parses the monolith to build a structured object containing all the rules, weights, and parameters required by the aggregation logic in Phases 4, 5, 6, and 7.</li>
            <li><strong>Certified Object Assembly:</strong> The final step is to assemble the certified configuration object, which encapsulates the validated monolith, its SHA-256 hash, the structural validation reports, and the newly created aggregation settings object. This object becomes available in the orchestrator's context for all subsequent phases.</li>
        </ol>

        <h2>4. System Diagram: Configuration Validation Flow</h2>
        <div class="diagram-container">
            <svg width="100%" viewBox="0 0 900 450" xmlns="http://www.w3.org/2000/svg" font-family="JetBrains Mono, monospace" font-size="12px">
                <defs>
                    <linearGradient id="grad-red" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#C41E3A"/><stop offset="100%" stop-color="#3A0E0E"/></linearGradient>
                    <linearGradient id="grad-blue" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#00D4FF"/><stop offset="100%" stop-color="#04101A"/></linearGradient>
                    <linearGradient id="grad-green" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#39FF14"/><stop offset="100%" stop-color="#0B231B"/></linearGradient>
                    <marker id="arrow-copper" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#B2642E"/></marker>
                </defs>
                <style>
                    .box { stroke-width: 1.5; rx: 4px; }
                    .box-red { fill: url(#grad-red); stroke: #C41E3A; }
                    .box-blue { fill: url(#grad-blue); stroke: #00D4FF; }
                    .box-green { fill: url(#grad-green); stroke: #39FF14; }
                    .label { fill: #E5E7EB; text-anchor: middle; }
                    .sub-label { fill: #E5E7EB; opacity: 0.7; font-size: 10px; text-anchor: middle; }
                    .flow-line { stroke: #B2642E; stroke-width: 1.5; marker-end: url(#arrow-copper); }
                    .gate { stroke: #C41E3A; stroke-width: 2; stroke-dasharray: 4,4; }
                </style>

                <!-- Input -->
                <rect x="50" y="50" width="180" height="60" class="box box-red"/>
                <text x="140" y="80" class="label">INPUT: Monolith Data</text>

                <!-- Process -->
                <rect x="360" y="50" width="180" height="60" class="box box-blue"/>
                <text x="450" y="75" class="label">PROCESS:</text>
                <text x="450" y="90" class="sub-label">_load_configuration()</text>

                <!-- Output -->
                <rect x="670" y="50" width="180" height="60" class="box box-green"/>
                <text x="760" y="80" class="label">OUTPUT: Certified Config</text>

                <path class="flow-line" d="M230 80 H 360"/>
                <path class="flow-line" d="M540 80 H 670"/>

                <!-- Validation Gates -->
                <g transform="translate(150, 150)">
                    <rect x="0" y="0" width="600" height="250" fill="rgba(0, 212, 255, 0.05)" stroke="#00D4FF" stroke-width="1" rx="8"/>
                    <text x="300" y="25" class="label" font-size="14px">Internal Validation Sequence</text>

                    <path class="gate" d="M20 50 H 580"/>
                    <text x="120" y="80" class="label">1. SHA-256 Hashing</text>
                    <text x="450" y="80" class="label" fill="#17A589">Ensures: Integrity</text>

                    <path class="gate" d="M20 110 H 580"/>
                    <text x="140" y="140" class="label">2. Component Census</text>
                    <text x="450" y="140" class="label" fill="#17A589">Ensures: Completeness</text>

                    <path class="gate" d="M20 170 H 580"/>
                    <text x="160" y="200" class="label">3. Structural Contract Validation</text>
                    <text x="450" y="200" class="label" fill="#17A589">Ensures: Coherence</text>
                </g>
                 <path class="flow-line" d="M450 110 V 160"/>
            </svg>
        </div>

        <h2>5. Illustrative Pseudocode</h2>
        <pre><code>
FUNCTION _load_configuration(monolith_data):
    // Step 1 & 2: Normalize and create cryptographic hash
    normalized_monolith = NORMALIZE(monolith_data)
    monolith_hash = SHA256(SERIALIZE(normalized_monolith))

    // Step 3: Perform quantitative audit
    question_count = COUNT_QUESTIONS(normalized_monolith)
    ASSERT question_count == EXPECTED_QUESTION_COUNT

    // Step 4: Perform deep structural and logical validation
    structure_report = _validate_contract_structure(normalized_monolith)
    ASSERT structure_report.is_valid

    // Step 5: Build aggregation rule set
    aggregation_rules = AggregationSettings.from_monolith(normalized_monolith)

    // Step 6: Assemble and return the certified object
    certified_config = {
        "monolith": normalized_monolith,
        "monolith_sha256": monolith_hash,
        "structure_report": structure_report,
        "_aggregation_settings": aggregation_rules
    }
    RETURN certified_config
        </code></pre>

        <h2>6. Operational Checklist for Auditing</h2>
        <ul>
            <li><strong>Verify Input:</strong> Confirm that the monolith data is being correctly passed to the orchestrator.</li>
            <li><strong>Check SHA-256 Hash:</strong> Independently generate the SHA-256 hash of the source monolith file and compare it with the hash stored in the certified configuration object to ensure integrity.</li>
            <li><strong>Audit Constants:</strong> Verify that the <code>EXPECTED_QUESTION_COUNT</code> constant aligns with the latest version of the analytical specification.</li>
            <li><strong>Review Structural Report:</strong> Examine the <code>structure_report</code> within the output for any recorded errors or inconsistencies, particularly regarding base slot counts and modality presence.</li>
            <li><strong>Inspect Aggregation Settings:</strong> Confirm that the <code>_aggregation_settings</code> object has been successfully created and attached to the final configuration object.</li>
        </ul>
    </div>
</body>
</html>
