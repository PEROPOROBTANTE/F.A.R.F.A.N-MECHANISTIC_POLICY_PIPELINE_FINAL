<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F.A.R.F.A.N. | Fase 2: Ejecución de Micro-Preguntas</title>
    <style>
        :root {
            --atroz-red-500: #C41E3A; --atroz-blue-electric: #00D4FF; --atroz-green-toxic: #39FF14;
            --atroz-copper-500: #B2642E; --atroz-copper-oxide: #17A589; --atroz-ink: #E5E7EB; --atroz-bg: #0A0A0A;
            --font-main: 'JetBrains Mono', monospace;
        }
        @font-face {
            font-family: 'JetBrains Mono';
            src: url('https://cdn.jsdelivr.net/gh/JetBrains/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2') format('woff2');
            font-weight: 400; font-style: normal;
        }
        body { background-color: var(--atroz-bg); color: var(--atroz-ink); font-family: var(--font-main); margin: 0; padding: 0; font-size: 14px; line-height: 1.8; }
        .container { max-width: 960px; margin: 0 auto; padding: 40px; }
        h1, h2, h3 { font-weight: 400; letter-spacing: 2px; text-transform: uppercase; }
        h1 { font-size: 28px; color: var(--atroz-blue-electric); border-bottom: 1px solid var(--atroz-copper-500); padding-bottom: 15px; margin-bottom: 30px; }
        h2 { font-size: 18px; color: var(--atroz-copper-oxide); margin-top: 50px; border-left: 3px solid var(--atroz-copper-oxide); padding-left: 10px; }
        h3 { font-size: 16px; color: var(--atroz-copper-500); margin-top: 30px; }
        p, li { text-align: justify; text-shadow: 0 0 2px rgba(229, 231, 235, 0.1); }
        ul, ol { padding-left: 20px; }
        li { margin-bottom: 10px; }
        code { background-color: #1a1a1a; padding: 3px 6px; border-radius: 4px; font-size: 12px; color: var(--atroz-blue-electric); }
        .diagram-container { margin: 50px 0; padding: 30px; background: radial-gradient(circle, rgba(0, 212, 255, 0.1) 0%, transparent: 70%); border: 1px solid var(--atroz-blue-electric); border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fase 2: Ejecución de Micro-Preguntas para Análisis Granular</h1>

        <h2>1. Propósito</h2>
        <p>
            La Fase 2 representa el motor analítico central del pipeline F.A.R.F.A.N., donde los datos estructurados de la Fase 1 son sometidos a una batería de consultas altamente específicas y dirigidas. El objetivo de esta fase es realizar un análisis granular y basado en evidencia mediante la ejecución de aproximadamente 300 "micro-preguntas" definidas en el monolito. Cada pregunta está diseñada para sondear un aspecto específico del documento de política dentro de un contexto temático estrictamente acotado. Esta fase opera de manera asíncrona para maximizar el rendimiento, distribuyendo la carga de trabajo analítica a través de un conjunto de ejecutores especializados. La salida es una colección de objetos <code>MicroQuestionRun</code>, cada uno conteniendo la evidencia en bruto extraída en respuesta a una única pregunta.
        </p>

        <h2>2. Definiciones Clave</h2>
        <ul>
            <li><strong>Micro-Pregunta:</strong> Una consulta analítica específica y bien definida del monolito, asociada a una Área de Política y Dimensión particular (ej., "¿Qué recursos financieros se asignan a las iniciativas de igualdad de género?").</li>
            <li><strong>Ejecutor (Executor):</strong> Una clase especializada (ej., <code>D1Q1_Executor</code>) responsable de la ejecución lógica de una única micro-pregunta. Contiene una <code>METHOD_SEQUENCE</code> que define la serie de métodos analíticos a ser invocados.</li>
            <li><strong>Documento Acotado (Scoped Document):</strong> Una versión temporal en memoria del <code>PreprocessedDocument</code> que ha sido filtrada para contener únicamente el o los dos Fragmentos de Política Inteligentes (SPCs) relevantes para la micro-pregunta específica en ejecución.</li>
            <li><strong>MicroQuestionRun:</strong> La estructura de datos que encapsula el resultado de la ejecución de una única micro-pregunta, incluyendo la evidencia extraída, metadatos y cualquier error encontrado.</li>
            <li><strong>Ejecución Asíncrona:</strong> El uso de la biblioteca <code>asyncio</code> de Python para ejecutar múltiples micro-preguntas de manera concurrente, gestionado por un semáforo para controlar la utilización de recursos.</li>
        </ul>

        <h2>3. Flujo Operacional Detallado</h2>
        <p>
            La ejecución de esta fase es gestionada por el método <code>Orchestrator._execute_micro_questions_async()</code>. El flujo se caracteriza por un patrón de tipo "map-reduce" altamente paralelizado.
        </p>
        <ol>
            <li><strong>Ordenamiento Estricto de Preguntas:</strong> La lista de todas las micro-preguntas del monolito se ordena primero por <code>dimension_id</code> y luego por <code>policy_area_id</code>. Esto asegura una secuencia de ejecución determinista y lógicamente agrupada, procesando todas las preguntas de la Dimensión 1 antes de pasar a la Dimensión 2, y así sucesivamente.</li>
            <li><strong>Creación de Tareas Asíncronas:</strong> Para cada una de las ~300 micro-preguntas, se crea una tarea asíncrona. Cada tarea es responsable del ciclo de vida completo de la ejecución de una única pregunta.</li>
            <li><strong>Filtrado Contextual:</strong> Dentro de cada tarea, el primer paso crítico es el filtrado. El sistema identifica el <code>policy_area_id</code> y <code>dimension_id</code> de la pregunta y filtra los 60 SPCs del <code>PreprocessedDocument</code> para crear un <strong>Documento Acotado</strong>. Este nuevo objeto contiene solo el o los dos SPCs que son temáticamente relevantes para la pregunta en cuestión. Este paso es fundamental para la eficiencia y la precisión analítica.</li>
            <li><strong>Instanciación del Ejecutor:</strong> Basado en el "base slot" de la pregunta (ej., 'D1-Q1'), se instancia la clase Ejecutor correspondiente (ej., <code>D1Q1_Executor</code> de <code>executors.py</code>).</li>
            <li><strong>Ejecución Delegada:</strong> Se invoca el método <code>execute</code> del Ejecutor instanciado, pasándole el Documento Acotado. El Ejecutor procede entonces a llamar la secuencia de métodos analíticos definidos en su <code>METHOD_SEQUENCE</code> interna, utilizando el <code>MethodExecutor</code> para resolverlos y ejecutarlos.</li>
            <li><strong>Agregación de Evidencia:</strong> El Ejecutor recopila los resultados de su secuencia de métodos y los empaqueta en un objeto <code>Evidence</code>.</li>
            <li><strong>Encapsulación del Resultado:</strong> La tarea asíncrona concluye creando un objeto <code>MicroQuestionRun</code>, que almacena la <code>Evidence</code> generada, los metadatos de la pregunta, la duración de la ejecución y cualquier error potencial.</li>
            <li><strong>Recolección de Resultados:</strong> El orquestador recolecta los resultados de todas las ~300 tareas asíncronas a medida que se completan. La fase finaliza una vez que todas las tareas han sido ejecutadas.</li>
        </ol>

        <h2>4. Diagrama de Sistema: Ejecución Asíncrona Fan-Out/Fan-In</h2>
        <div class="diagram-container">
            <svg width="100%" viewBox="0 0 900 700" xmlns="http://www.w3.org/2000/svg" font-family="JetBrains Mono, monospace" font-size="12px">
                <defs>
                    <linearGradient id="grad-blue" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#00D4FF"/><stop offset="100%" stop-color="#04101A"/></linearGradient>
                    <linearGradient id="grad-green" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#39FF14"/><stop offset="100%" stop-color="#0B231B"/></linearGradient>
                     <marker id="arrow-copper" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#B2642E"/></marker>
                </defs>
                <style>
                    .box { stroke-width: 1.5; rx: 4px; }
                    .box-blue { fill: url(#grad-blue); stroke: #00D4FF; }
                    .box-green { fill: url(#grad-green); stroke: #39FF14; }
                    .label { fill: #E5E7EB; text-anchor: middle; }
                    .sub-label { fill: #E5E7EB; opacity: 0.7; font-size: 9px; text-anchor: middle; }
                    .flow-line { stroke: #B2642E; stroke-width: 1.5; marker-end: url(#arrow-copper); }
                </style>

                <rect x="350" y="20" width="200" height="60" class="box box-green"/>
                <text x="450" y="50" class="label">PreprocessedDocument</text>
                <text x="450" y="65" class="sub-label">(60 SPCs)</text>

                <rect x="350" y="120" width="200" height="60" class="box box-blue"/>
                <text x="450" y="150" class="label">_execute_micro_</text>
                <text x="450" y="165" class="label">questions_async()</text>

                <path class="flow-line" d="M450 80 V 120"/>

                <path class="flow-line" d="M450 180 V 220"/>
                <text x="470" y="205" class="sub-label" fill="#B2642E">Fan-Out: ~300 Tareas Asíncronas</text>

                <!-- Concurrent Executors -->
                <g transform="translate(50, 220)">
                    <rect x="0" y="0" width="180" height="200" fill="rgba(0,212,255,0.05)" stroke="#00D4FF" stroke-dasharray="3,3" rx="4"/>
                    <text x="90" y="25" class="label" font-size="10px">Tarea: D1Q1_Executor</text>
                    <rect x="20" y="45" width="140" height="40" class="box box-blue" opacity="0.7"/>
                    <text x="90" y="70" class="label" font-size="9px">Filtrar para PA01, DIM01</text>
                    <rect x="20" y="105" width="140" height="40" class="box box-blue" opacity="0.7"/>
                    <text x="90" y="130" class="label" font-size="9px">executor.execute()</text>
                    <rect x="40" y="165" width="100" height="30" class="box box-green" opacity="0.7"/>
                    <text x="90" y="185" class="label" font-size="9px">Evidencia</text>
                </g>

                 <g transform="translate(360, 220)">
                    <rect x="0" y="0" width="180" height="200" fill="rgba(0,212,255,0.05)" stroke="#00D4FF" stroke-dasharray="3,3" rx="4"/>
                    <text x="90" y="25" class="label" font-size="10px">Tarea: D1Q2_Executor</text>
                    <rect x="20" y="45" width="140" height="40" class="box box-blue" opacity="0.7"/>
                    <text x="90" y="70" class="label" font-size="9px">Filtrar para PA02, DIM01</text>
                    <rect x="20" y="105" width="140" height="40" class="box box-blue" opacity="0.7"/>
                    <text x="90" y="130" class="label" font-size="9px">executor.execute()</text>
                    <rect x="40" y="165" width="100" height="30" class="box box-green" opacity="0.7"/>
                    <text x="90" y="185" class="label" font-size="9px">Evidencia</text>
                </g>

                <g transform="translate(670, 220)">
                    <rect x="0" y="0" width="180" height="200" fill="rgba(0,212,255,0.05)" stroke="#00D4FF" stroke-dasharray="3,3" rx="4"/>
                    <text x="90" y="25" class="label" font-size="10px">Tarea: D6Q5_Executor</text>
                     <rect x="20" y="45" width="140" height="40" class="box box-blue" opacity="0.7"/>
                    <text x="90" y="70" class="label" font-size="9px">Filtrar para PA10, DIM06</text>
                    <rect x="20" y="105" width="140" height="40" class="box box-blue" opacity="0.7"/>
                    <text x="90" y="130" class="label" font-size="9px">executor.execute()</text>
                    <rect x="40" y="165" width="100" height="30" class="box box-green" opacity="0.7"/>
                    <text x="90" y="185" class="label" font-size="9px">Evidencia</text>
                </g>

                <text x="295" y="320" class="label" font-size="20px">...</text>
                <text x="605" y="320" class="label" font-size="20px">...</text>

                <path class="flow-line" d="M140 420 v 80"/>
                <path class="flow-line" d="M450 420 v 80"/>
                <path class="flow-line" d="M760 420 v 80"/>

                <path d="M140 500 h 620" class="flow-line"/>
                <text x="350" y="460" class="sub-label" fill="#B2642E">Fan-In: Recolectar Resultados</text>

                <rect x="350" y="540" width="200" height="60" class="box box-green"/>
                <text x="450" y="570" class="label">Lista de ~300</text>
                <text x="450" y="585" class="label">Objetos MicroQuestionRun</text>

                <path class="flow-line" d="M450 500 v 40"/>

            </svg>
        </div>

        <h2>5. Pseudocódigo Ilustrativo</h2>
        <pre><code>
FUNCIÓN ASÍNCRONA _execute_micro_questions_async(documento, config):
    // Paso 1: Ordenar todas las preguntas de forma determinista
    todas_las_preguntas = ORDENAR(config.micro_preguntas, POR=['dimension_id', 'policy_area_id'])

    tareas = []
    // Paso 2: Crear una tarea asíncrona para cada pregunta
    PARA pregunta EN todas_las_preguntas:
        tarea = CREAR_TAREA(procesar_pregunta_individual(documento, pregunta))
        tareas.APILAR(tarea)

    // Paso 8: Recolectar resultados a medida que se completan
    resultados = ESPERAR asyncio.gather(*tareas)
    RETORNAR resultados

FUNCIÓN ASÍNCRONA procesar_pregunta_individual(documento, pregunta):
    // Paso 3: Filtrar SPCs para crear un contexto acotado
    chunks_acotados = FILTRAR(documento.chunks, DONDE chunk.pa_id == pregunta.pa_id Y chunk.dim_id == pregunta.dim_id)
    documento_acotado = nuevo PreprocessedDocument(chunks=chunks_acotados)

    // Paso 4: Instanciar el ejecutor correcto
    ClaseEjecutor = OBTENER_CLASE_EJECUTOR(pregunta.base_slot)
    ejecutor = nuevo ClaseEjecutor(method_executor, ...)

    // Paso 5 & 6: Delegar ejecución y obtener evidencia
    evidencia = ESPERAR EN_HILO(ejecutor.execute(documento_acotado))

    // Paso 7: Encapsular el resultado final
    RETORNAR nuevo MicroQuestionRun(question_id, evidencia, ...)
        </code></pre>

        <h2>6. Lista de Verificación Operacional para Auditoría</h2>
        <ul>
            <li><strong>Verificar Artefacto de Entrada:</strong> Confirmar que el <code>PreprocessedDocument</code> de la Fase 1, conteniendo exactamente 60 SPCs, es la entrada a esta fase.</li>
            <li><strong>Comprobar Recuento de Salida:</strong> La lista de salida final debe contener un número de objetos <code>MicroQuestionRun</code> igual al número de micro-preguntas definidas en el monolito (~300).</li>
            <li><strong>Auditar Documentos Acotados:</strong> Para una muestra de preguntas, verificar que el Documento Acotado pasado al ejecutor contiene únicamente los SPCs que coinciden con el Área de Política y la Dimensión de la pregunta.</li>
            <li><strong>Inspeccionar Objetos de Evidencia:</strong> Examinar una muestra de los objetos <code>Evidence</code> resultantes para confirmar que los ejecutores los están poblando exitosamente con datos extraídos (ej., elementos de texto, puntuaciones de confianza).</li>
            <li><strong>Monitorear Errores:</strong> Comprobar el campo <code>error</code> en los objetos de salida. Un número elevado de errores puede indicar problemas con implementaciones específicas de Ejecutores o con los métodos analíticos subyacentes.</li>
        </ul>
    </div>
</body>
</html>
